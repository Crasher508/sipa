language: python
sudo: required
dist: xenial

cache:
  - pip

python:
  - "3.7"

services:
  - docker

env:
  global:
    - DOCKER_CACHE_FILE=/home/travis/docker/cache.tar.gz
    - DOCKER_IMAGE_NAME=sipa
    - DOCKER_COMPOSE="docker-compose -f build/testing/docker-compose.yml"

before_install:
  - apt-cache madison docker-engine
  - "docker version"
  - "docker-compose version"
  - ./helpers/docker_cache.sh load_cache || echo "Cache loading failed"
  - "docker images -a"

install:
  - pip install -r ./build/requirements/requirements.txt
  - pip install -r ./build/requirements/requirements_testing.txt

script:
  # - echo "Running local tests…" && python manage.py test  # skips integration tests
  - "pycodestyle ."
  - $DOCKER_COMPOSE build
  - echo "Running complete test suite…" && $DOCKER_COMPOSE run --rm sipa_testing_no_volumes python manage.py test
  - echo "Building documentation…" && make docs

after_success:
  # we don't want to deploy from the testing compose file
  # due to the additional testing requirements in this image
  - docker-compose -f build/dev/docker-compose.yml build sipa
  - sudo ./helpers/registry.sh all

deploy:
  # See https://docs.travis-ci.com/user/deployment/pages/
  provider: pages
  skip-cleanup: true
  # THIS MUST BE A PERSONAL ACCESS TOKEN (not of the organization)!
  # To be set in the travis settings page as a secure variable
  github-token: $GITHUB_TOKEN
  keep-history: true
  local_dir: build/html

before_cache:
  - ./helpers/docker_cache.sh save_cache || echo "Cache saving failed"

stages:
  - name: deploy
    if: branch IN (master, develop)
